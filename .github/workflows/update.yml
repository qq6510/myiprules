name: 获取并处理数据

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 获取 Mihomo 下载链接
        run: |
          echo "正在获取 Mihomo 下载链接..."
          
          # 使用更稳定的 API 方法，获取最新版本信息
          RELEASES=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)
          
          # 尝试多种下载模式（按优先级）
          # 1. 首先尝试 amd64-v1 (兼容性最好)
          MIHOMO_URL=$(echo "$RELEASES" | grep -o '"browser_download_url":"[^"]*linux-amd64-v1\.gz"' | head -1 | cut -d'"' -f4)
          
          # 2. 如果找不到，尝试 amd64-v2
          if [ -z "$MIHOMO_URL" ]; then
            echo "提示: amd64-v1 版本未找到，尝试 amd64-v2..."
            MIHOMO_URL=$(echo "$RELEASES" | grep -o '"browser_download_url":"[^"]*linux-amd64-v2\.gz"' | head -1 | cut -d'"' -f4)
          fi
          
          # 3. 如果还是找不到，尝试通用 amd64-compatible
          if [ -z "$MIHOMO_URL" ]; then
            echo "提示: amd64-v2 版本未找到，尝试 amd64-compatible..."
            MIHOMO_URL=$(echo "$RELEASES" | grep -o '"browser_download_url":"[^"]*linux-amd64-compatible\.gz"' | head -1 | cut -d'"' -f4)
          fi
          
          # 4. 最后尝试通用 amd64
          if [ -z "$MIHOMO_URL" ]; then
            echo "提示: amd64-compatible 版本未找到，尝试通用 amd64..."
            MIHOMO_URL=$(echo "$RELEASES" | grep -o '"browser_download_url":"[^"]*linux-amd64\.gz"' | head -1 | cut -d'"' -f4)
          fi
          
          if [ -z "$MIHOMO_URL" ]; then
            echo "错误：未能找到任何 Mihomo 下载链接！"
            exit 1
          fi
          
          echo "下载地址: $MIHOMO_URL"
          curl -L -o mihomo.gz "$MIHOMO_URL"
          
          if [ ! -f mihomo.gz ]; then
            echo "错误：文件下载失败"
            exit 1
          fi
          
          gunzip -c mihomo.gz > mihomo
          chmod +x mihomo
          ./mihomo -v # 验证版本，确保下载成功

      - name: 获取IP规则列表并处理
        run: |
          echo "Processing IP rules..."
          # 这里添加你的IP规则处理逻辑

      - name: 提交更改
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Automatic IP rules update" || echo "No changes to commit"
          git push
